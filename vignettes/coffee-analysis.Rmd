---
title: "Coffee Price Causality Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Coffee Price Causality Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

This vignette demonstrates how to analyze causality relationships between different coffee price types (Arabica and Robusta) using the `grangertdyigraph` package. We'll use both standard Granger causality tests and the more robust Toda-Yamamoto procedure.

## Data Overview

The `coffee_data` dataset included in this package contains monthly prices of Arabica and Robusta coffee from 1960 to 2011.

```{r setup}
library(grangertdyigraph)
data(coffee_data)

# Overview of the data
str(coffee_data)
summary(coffee_data[, c("Arabica", "Robusta")])
```

Let's visualize the time series data to get a better understanding:

```{r plot_data, fig.width=8, fig.height=5}
# Plot the time series
plot(coffee_data$Date, coffee_data$Arabica, type="l", col="darkgreen", 
     xlab="Year", ylab="Price", main="Coffee Price Trends")
lines(coffee_data$Date, coffee_data$Robusta, col="brown")
legend("topleft", legend=c("Arabica", "Robusta"), col=c("darkgreen", "brown"), lwd=1)
```

## Granger Causality Analysis

First, let's perform the standard Granger causality test to see if past values of one coffee type can help predict future values of the other.

```{r granger_test}
# Perform Granger causality test
result <- granger_test(coffee_data[, c("Arabica", "Robusta")], max_lag = 3)

# Examine the p-values
print("P-values for Granger causality:")
print(result$p_values)

# Examine which relationships are significant
print("Significant causal relationships:")
print(result$significance)
```

Now, let's visualize these causality relationships as a network:

```{r network_plot, fig.width=7, fig.height=5}
# Create and plot network
g <- plot_granger_network(result)
plot(g)
```

## Dynamic Causality Analysis

We can also analyze how causal relationships between coffee prices have evolved over time using a rolling window approach:

```{r dynamic_analysis}
# Create dynamic graph with rolling windows
dyn_graph <- create_dynamic_graph(
  coffee_data[, c("Arabica", "Robusta")], 
  window_size = 50,  # Size of each window (50 months)
  step = 10,          # Step size between windows
  max_lag = 2         # Maximum lag to consider
)

# Number of time windows
length(dyn_graph$time_points)
```

The visualization of the dynamic causality network would show how the relationship between Arabica and Robusta coffee prices has changed over the decades.

## Toda-Yamamoto Causality Analysis

Since time series of coffee prices might have unit roots, we'll also use the Toda-Yamamoto procedure, which is more robust to non-stationary data.

```{r ty_analysis}
# Load required package
library(vars)

# Find optimal lag order
lagselect <- VARselect(coffee_data[, c("Arabica", "Robusta")], lag.max = 6, type = "both")
optimal_lag <- lagselect$selection[1]  # Using AIC criterion
print(paste("Optimal lag order:", optimal_lag))

# Create VAR model
var_model <- VAR(coffee_data[, c("Arabica", "Robusta")], p = optimal_lag, type = "both")

# Run Toda-Yamamoto causality test
ty_result <- toda_yamamoto(var_model)
print("Toda-Yamamoto Causality Test Results:")
print(ty_result)
```

Let's visualize the Toda-Yamamoto causality network:

```{r ty_network, fig.width=7, fig.height=5}
# Create and plot network
plot_ty_network(ty_result)
```

## Conclusion

In this analysis, we've examined the causal relationships between Arabica and Robusta coffee prices using both standard Granger causality tests and the more robust Toda-Yamamoto procedure. The results help us understand whether movements in one coffee price type precede and can help predict movements in the other.

This type of analysis can be valuable for coffee traders, roasters, and other stakeholders in the coffee industry who need to understand price dynamics and potential lead-lag relationships between different coffee varieties.
